#!/usr/bin/make -f

PKG_VERSION := $(shell dpkg-parsechangelog | awk '/^Version:/ {print $$2}')
LLVM_VERSION := 21

%:
	dh $@

stamps/configure: stamps/preconfigure
	:

stamps/preconfigure:
	rm -rf build
	mkdir -p build/_deps/
	cp -rf vendor/emhash build/_deps/emhash-headers-src
	cp -rf vendor/parallel-hashmap build/_deps/parallel-hashmap-src
	mkdir -p build/content-exp-headers/
	cp -rf vendor/compute-runtime/level_zero/ build/content-exp-headers/

override_dh_auto_configure: stamps/configure
	python3 ${CURDIR}/buildbot/configure.py \
		--l0-headers /usr/include/level_zero/ \
		--l0-loader /usr/lib/x86_64-linux-gnu/libze_loader.so \
		--cmake-opt="-DLLVM_PARALLEL_LINK_JOBS=16" \
		--disable-jit \
		--cmake-opt="-DLLVM_ENABLE_RTTI=ON" \
		--cmake-opt="-DLLVM_BUILD_LLVM_DYLIB:BOOL=ON" \
		--cmake-opt="-DSYCL_UR_USE_FETCH_CONTENT=OFF" \
		--cmake-opt="-DLLVMGenXIntrinsics_SOURCE_DIR=${CURDIR}/vendor/vc-intrinsics" \
		--cmake-opt="-DFETCHCONTENT_FULLY_DISCONNECTED=ON" \
		--cmake-opt="-DSYCL_UR_SOURCE_DIR=${CURDIR}/vendor/unified-runtime" \
		--cmake-opt="-DUR_OPENCL_INCLUDE_DIR=/usr/include/" \
		--cmake-opt="-DUR_USE_EXTERNAL_UMF=ON" \
		--cmake-opt="-DOpenCL_INCLUDE_DIR=/usr/include/" \
		--cmake-opt="-DBOOST_MP11_SOURCE_DIR=${CURDIR}/vendor/mp11-boost" \
		--cmake-opt="-DLLVM_EXTERNAL_SPIRV_HEADERS_SOURCE_DIR=/usr/include/" \

override_dh_auto_build:
	python3 ${CURDIR}/buildbot/compile.py -j`nproc`

override_dh_auto_install:
	# Install binaries to debian/tmp/usr
	cd build && DESTDIR=$(CURDIR)/debian/tmp ninja install

# TODO
override_dh_shlibdeps:
	:
	#dh_shlibdeps -ldebian/tmp/src/build/install/lib/ --dpkg-shlibdeps-params=--ignore-missing-info

override_dh_clean:
	rm -rf ${UR_BUILD_XPTI_LIBS}
	dh_clean
